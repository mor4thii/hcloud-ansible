---
# Create or ensure server present; attach firewall and the previously created Primary IPs.
- name: Create Hetzner server with attached firewall + IPs
  hetzner.hcloud.server:
    name: "{{ hcloud_server_name }}"
    server_type: "{{ hcloud_server_type }}"
    image: "{{ hcloud_image }}"
    # Use either location or datacenter. Prefer location for flexibility.
    location: "{{ hcloud_location }}"
    ssh_keys: "{{ hcloud_ssh_keys }}"
    firewalls:
      - "{{ hcloud_firewall_name }}"
    ipv4: "{{ hcloud_primary_ipv4_name }}"
    ipv6: "{{ hcloud_primary_ipv6_name }}"
    labels: "{{ hcloud_labels }}"
    state: present
  register: hcloud_server

- name: Wait for SSH on new server (IPv4 preferred)
  ansible.builtin.wait_for:
    host: "{{ hcloud_server.server.ipv4_address }}"
    port: 22
    timeout: 300

# Expose this server as a temp inventory host so subsequent plays can target it
- name: Add the new server to in-memory inventory
  ansible.builtin.add_host:
    name: "{{ hcloud_server.server.name }}"
    groups: new_servers
    ansible_host: "{{ hcloud_server.server.ipv4_address }}"
    ansible_user: root

